<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shizhenqiang.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="We used to look up at the sky and wonder at our place in the stars, now we just look down and worry about our place in the dirt.">
<meta property="og:type" content="website">
<meta property="og:title" content="Chelf Blog">
<meta property="og:url" content="https://shizhenqiang.github.io/index.html">
<meta property="og:site_name" content="Chelf Blog">
<meta property="og:description" content="We used to look up at the sky and wonder at our place in the stars, now we just look down and worry about our place in the dirt.">
<meta property="og:locale">
<meta property="article:author" content="Chelf">
<meta property="article:tag" content="DO">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://shizhenqiang.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Chelf Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Chelf Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">To let your hair down</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Chelf</p>
  <div class="site-description" itemprop="description">We used to look up at the sky and wonder at our place in the stars, now we just look down and worry about our place in the dirt.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives">
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shizhenqiang.github.io/2023/01/20/zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chelf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chelf Blog">
      <meta itemprop="description" content="We used to look up at the sky and wonder at our place in the stars, now we just look down and worry about our place in the dirt.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Chelf Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/01/20/zookeeper/" class="post-title-link" itemprop="url">ZooKeeper在大型分布式系统中的应用场景</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-01-20 08:54:27" itemprop="dateCreated datePublished" datetime="2023-01-20T08:54:27+08:00">2023-01-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-09 10:13:32" itemprop="dateModified" datetime="2023-03-09T10:13:32+08:00">2023-03-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、什么是分布式系统？"><a href="#一、什么是分布式系统？" class="headerlink" title="一、什么是分布式系统？"></a>一、什么是分布式系统？</h2><blockquote>
<p>分布式系统是一个硬件或者软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统。</p>
<p>​                                                                                                                                                    —— 《分布式系统概念与设计》</p>
</blockquote>
<p>分布式环境的各种问题诸多，此处只列举一些<strong>典型的问题</strong>。</p>
<p>1、通信异常</p>
<p>2、网络分区</p>
<p>​       网络异常后，导致系统中节点的网络延时不断增大，导致只有部分节点能进行正常通信。</p>
<h2 id="二、什么是Zookeeper？"><a href="#二、什么是Zookeeper？" class="headerlink" title="二、什么是Zookeeper？"></a>二、什么是Zookeeper？</h2><p>Zookeeper是一个典型的分布式协调服务，致力于高性能、高可用，且具用严格的顺序访问控制能力。</p>
<p>在hadoop中，zookeeper主要用于实现HA（High Availability），这部分逻辑主要集中在hadoop Common的HA模块中，HDFS的NameNode与Yarn的ResouceManager都是基于此HA模块来实现自己的HA功能的。同时，在YARN中又特别提供了Zookeeper来存储应用的运行状态。</p>
<h2 id="三、Yarn中的Zookeeper"><a href="#三、Yarn中的Zookeeper" class="headerlink" title="三、Yarn中的Zookeeper"></a>三、Yarn中的Zookeeper</h2><p>Yarn，分布式资源调度框架，支持我们常用的Mapreduce计算引擎，当然，也支持其他的计算引擎，如Spark，Storm等。</p>
<p>此处仅介绍为何需要Zookeeper，具体架构不做细节分析。ResourceManager是Yarn的一个核心且复杂组件，负责集群所有资源的管理和分配，接受各个节点的资源汇总情况，将信息按一定策略分配给应用程序（Application Manager），但是目前一个明显的缺陷就是RM是一个单点，为解决高可用，Yarn设计了一套Active&#x2F;Standby模式的RM HA架构。运行期间，多个RM并存，但是只有一个处于Active状态，其余则为Standby状态，出现问题后，Stanby节点竞争选举产生新的Active节点。而这个时候，就是利用Zookeeper来<strong>实现RM的主备切换</strong>的过程。</p>
<p>简单分三步：</p>
<ul>
<li><p>创建锁节点</p>
<p>在Zookeeper上竞争写一个Lock的子节点（临时节点，Zookeeper上的节点分为临时和持久节点），创建成功的为Active。</p>
</li>
<li><p>注册监听器</p>
<p>其余Standby节点注册节点变更的监听（Watcher），临时节点的特性，能迅速感知Active节点的运行状态。</p>
</li>
<li><p>主备切换</p>
<p>当Active节点故障，Zookeeper上的Lock节点会删除，此时重复第一步。为防止“脑裂”现象（假死后的RM恢复后，认为自己还是Active。此时相当于多个Active了），创建锁节点时，携带Zookeeper的ACL信息，目的是独占该根节点，防止其他的RM对其更新。这个机制称为Fencing机制。</p>
</li>
</ul>
<p>当然，RM上的一些状态信息，也会存储在Zookeeper，比如与各个Application相关的信息。HDFS的NameNode也有相似的处理。</p>
<h2 id="四、hbase中的Zookeeper"><a href="#四、hbase中的Zookeeper" class="headerlink" title="四、hbase中的Zookeeper"></a>四、hbase中的Zookeeper</h2><p>Hbase是一个数据写入具有强一致性的高可靠、高性能、面向列、可伸缩的分布式存储系统。在Hbase的整个架构体系中，Zookeeper是串联起Hbase集群与Client的关键所在。详细读写分析可参考2019年的Hbase初探。Zookeeper在Hbase中的应用场景众多，主要分为以下五大方面。</p>
<ul>
<li><p>系统容错</p>
<p>HMaster会监听在Zookeeper上的RegionServer创建的节点，这样，每一个RegionServer出现问题，Hmaster就会感知，立刻开始容错同步。这个监控交给Zookeeper，其实也缓解了Hmaster的压力，毕竟Regionserver的数量过大，对于Hmaster也有性能影响。</p>
</li>
<li><p>RootRegion管理</p>
<p>可以当做一个所有数据位置的一个信息存储地点（元数据分片），客户端访问时能保证总能拿到正确的RootRegion信息。</p>
</li>
<li><p>Region状态管理</p>
<p>Region是Hbase的一个物理分片，每个Regin记录全局数据的一小部分，且不同Region数据不重复。当然，系统故障、负载均衡、配置或者Regiion的分裂合并都会影响其状态，Region的状态变化也是交给Zookeeper来管理的，防止Region变化导致全局的节点无法立刻知晓。</p>
</li>
<li><p>分布式SplitLog任务管理</p>
<p>SplitLog的责任就是当RegionServer发生故障进行数据迁移时，要从HLOG（保证写入可靠）恢复还在内存中的数据（还没有来的及持久化HFile中）。由于Region众多，系统想要快速恢复需要把HLOG的任务分配多台RegionServer共同处理，这个时候，Zookeeper就扮演了一个相互通信和信息持久化的角色，Hmaster会在Zookeeper上创建一个节点（splitlog），“哪个Regionserver处理哪个Region”的信息。这样由各个RegionServer来领取任务并更新该节点，通知Hmater其余的剩下的步骤。</p>
</li>
<li><p>Replication管理</p>
<p>Replication是实现Hbase中主备集群的实时同步重要模块。当然也是借助Zookeeper来完成的。注册节点Replication节点，把不同的RegionServer服务器对应的HLOG记录到相应的节点上，Hmaster会将新增的数据推送给Slave集群，并同时将信息记录到Zookeeper（断点记录）。如果RS挂掉了，那么有这些断点信息就可以个协调进行复制。</p>
</li>
</ul>
<h2 id="五、kafka中的Zookeeper"><a href="#五、kafka中的Zookeeper" class="headerlink" title="五、kafka中的Zookeeper"></a>五、kafka中的Zookeeper</h2><p>Kafka是一个吞吐量高、低延迟的分布式消息系统。</p>
<p>Kafka从设计之初，就是一个大规模的分布式消息中间件，其服务端存在多个Broker，为了达到负载均衡，他将每个Topic消息分成多个分区，并分布在不同的Broker上，多个生产者能够同事发送和消费数据，Kafka使用Zookeeper作为其分布式协调框架，很好的将消息生产、消息存储、消息消费有机的结合起来。通过Zookeeper，进行Broker的注册、Topic的注册以及Watcher通知能够获取Broker和Topic的变化情况。</p>
<p>更多的负载均衡细节可以参考《 从Paxos到Zookeeper分布式一致性原理与实践》。</p>
<h1 id="全部参考"><a href="#全部参考" class="headerlink" title="全部参考"></a>全部参考</h1><p>[1] 从Paxos到Zookeeper分布式一致性原理与实践,</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shizhenqiang.github.io/2022/11/18/Knowledge-Graph/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chelf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chelf Blog">
      <meta itemprop="description" content="We used to look up at the sky and wonder at our place in the stars, now we just look down and worry about our place in the dirt.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Chelf Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/18/Knowledge-Graph/" class="post-title-link" itemprop="url">Knowledge Graph</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-18 09:37:46" itemprop="dateCreated datePublished" datetime="2022-11-18T09:37:46+08:00">2022-11-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-09 10:25:34" itemprop="dateModified" datetime="2023-03-09T10:25:34+08:00">2023-03-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、什么是知识图谱？"><a href="#一、什么是知识图谱？" class="headerlink" title="一、什么是知识图谱？"></a>一、什么是知识图谱？</h2><blockquote>
<p><strong>A knowledge graph acquires and integrates information into an ontology and applies a reasoner to derive new knowledge.</strong></p>
<p>​                                                                              —–<strong>Ehrlinger and WoB</strong></p>
</blockquote>
<p>知识图谱会获取信息并将其集成到一个本体中，使用一个推理器产生新的知识。</p>
<p>知识图谱的概念其实比较多和杂，没有一个固定的统一说法。知识图谱是一种用图模型来描述知识和建模事物之间关联关系的技术。</p>
<p>知识图谱 (KG) 是一种用图模型来描述知识和建模事物之间关联关系的技术. 知识图谱嵌入 (KGE) 作为一种被广泛采用的知识表示方法, 其主要思想是将知识图谱中的实体和关系嵌入到连续的向量空间中, 用来简化操作, 同时保留 KG 的固有结构. 可以使得多种下游任务受益, 例如 KG 补全和关系提取等. 首先对现有的知识图谱嵌入技术进行全面回顾, 不仅包括使用 KG 中观察到的事实进行嵌入的技术, 还包括添加时间维度的动态 KG 嵌入方法, 以及融合多源信息的 KG 嵌入技术. 对相关模型从实体嵌入、关系嵌入、评分函数等方面进行分析、对比与总结. 然后简要介绍 KG 嵌入技术在下游任务中的典型应用, 包括问答系统、推荐系统和关系提取等. 最后阐述知识图谱嵌入面临的挑战, 对未来的研究方向进行展望.</p>
<h2 id="二、应用"><a href="#二、应用" class="headerlink" title="二、应用"></a>二、应用</h2><ul>
<li><p>基于知识图谱嵌入的问答</p>
<p>随着大规模知识图谱的兴起, 基于知识图谱的问答 (QA) 成为重要的研究方向, 引起了人们的广泛关注. 现实世界的领域中通常包含数百万到数十亿个事实, 其庞大的数据量和复杂的数据结构使得用户很难访问其中有价值的知识. 为了缓解这个问题, 提出了基于知识图谱的问答 (QA-KG).</p>
</li>
<li><p>推荐系统</p>
<p>在过去的几年中, 利用知识图谱的推荐系统已被证明与最先进的协作过滤系统具有竞争力, 能有效地解决新项目和数据稀疏性等问题 . 最近, KGE 的流行促进了利用 KGE 捕获实体语义进行推荐这一研究热点, 使用KGE 已被证明对推荐系统有效.</p>
</li>
<li><p>关系提取</p>
<p>关系提取 (relation extraction, RE) 是信息提取中的一项重要任务, 旨在根据两个给定实体的上下文来提取它们之间的关系. 由于 RE 具有提取文本信息的能力, 并使许多自然语言处理应用受益 (例如: 信息检索, 对话生成,问答等), 因此受到很多研究者的青睐.</p>
</li>
</ul>
<h2 id="三、与图数据库的一个小例子"><a href="#三、与图数据库的一个小例子" class="headerlink" title="三、与图数据库的一个小例子"></a>三、与图数据库的一个小例子</h2><p>用于存储图关系的数据库，下面简单介绍一下neo4j的用法。</p>
<p>你可以使用doker快速安装并启动一个neo4j数据库。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> --name neo4j \</span></span><br><span class="line"><span class="language-bash">-d \</span></span><br><span class="line"><span class="language-bash">-p 7474:7474 \</span></span><br><span class="line"><span class="language-bash">-p 7687:7687 \</span></span><br><span class="line"><span class="language-bash">-v ./neo4j/data:/data \</span></span><br><span class="line"><span class="language-bash">-v ./neo4j/logs:/logs \</span></span><br><span class="line"><span class="language-bash">-v ./neo4j/conf:/var/lib/neo4j/conf \</span></span><br><span class="line"><span class="language-bash">-v ./neo4j/import:/var/lib/neo4j/import \</span></span><br><span class="line"><span class="language-bash">--<span class="built_in">env</span> NEO4J_AUTH=neo4j/bigdata \</span></span><br><span class="line"><span class="language-bash">neo4j:4.3.21-community</span></span><br></pre></td></tr></table></figure>

<p>注意文件位置的可读可写权限。那么就可以在<a target="_blank" rel="noopener" href="http://localhost:7474/">http://localhost:7474/</a>    访问neo4j。</p>
<img src="/2022/11/18/Knowledge-Graph/image-20221205153727189.png" class title="demo asset_img">

<p>具体的插入命令，你可以去学习cypher。</p>
<p>当然也可以学习python的包—py2neo，下面一个简单的例子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph, Node, Relationship, NodeMatcher, RelationshipMatcher</span><br><span class="line">graph = Graph(<span class="string">&quot;bolt://127.0.0.1:7687&quot;</span>, auth=(<span class="string">&quot;neo4j&quot;</span>, <span class="string">&quot;password&quot;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_rel</span>():</span><br><span class="line">    matcher = NodeMatcher(graph)</span><br><span class="line">    rmatcher = RelationshipMatcher(graph)</span><br><span class="line">    node_model = matcher.match(<span class="string">&quot;Model&quot;</span>, name=<span class="string">&quot;A模型&quot;</span>).first()</span><br><span class="line">    node_feature = matcher.match(<span class="string">&quot;Feature&quot;</span>, name=<span class="string">&quot;C特征&quot;</span>).first()</span><br><span class="line">    r1 = rmatcher.match(&#123;node_model,node_feature&#125;).first() </span><br><span class="line">    <span class="built_in">print</span>(r1)</span><br><span class="line">    </span><br><span class="line">all_nodes = graph.run(<span class="string">&#x27;MATCH (n) RETURN n&#x27;</span>).data()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> nodes <span class="keyword">in</span> all_nodes:</span><br><span class="line">    <span class="built_in">print</span>(nodes)</span><br><span class="line"></span><br><span class="line">get_rel()</span><br></pre></td></tr></table></figure>

<h2 id="四、未来方向"><a href="#四、未来方向" class="headerlink" title="四、未来方向"></a>四、未来方向</h2><ul>
<li><p>统一框架</p>
</li>
<li><p>可解释性</p>
<p>知识表示的可解释性是知识获取和实际应用中的关键问题. 现有方法已为可解释性作出了初步努力.ITransF 采用稀疏向量进行知识迁移, 通过注意力可视化进行解释.等等， 探索了知识图谱的解释方案. 然而, 这些神经模型在透明度和可解释性方面受到了限制, 一些方法结合逻辑规则来提高互操作性, 从而将黑盒神经模型与符号推理相结合. 因此, 应该进一步研究可解释性并提高预测知识的可靠性.</p>
</li>
<li><p>可扩展性</p>
</li>
<li><p>自动构建</p>
<p>当前的 KG 高度依赖于人工构建, 这是劳动密集且昂贵的. 知识图谱在不同认知智能领域的广泛应用需要从<br>大规模的非结构化内容中自动构建知识图谱. 最近的研究主要是在现有知识图的监督下进行半自动构建. 面对多<br>模态, 异构性和大规模应用, 自动构建仍然是未来亟待解决的重要问题.</p>
</li>
</ul>
<h2 id="五、参考"><a href="#五、参考" class="headerlink" title="五、参考"></a>五、参考</h2><p>1、知识图谱嵌入技术研究综述，软件学报，张天成 , 田 雪 , 孙相会 , 于明鹤 , 孙艳红  , 于 戈 </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shizhenqiang.github.io/2022/02/22/Deep-learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chelf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chelf Blog">
      <meta itemprop="description" content="We used to look up at the sky and wonder at our place in the stars, now we just look down and worry about our place in the dirt.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Chelf Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/22/Deep-learning/" class="post-title-link" itemprop="url">卷积神经网络简单实现及部署</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-22 11:24:56" itemprop="dateCreated datePublished" datetime="2022-02-22T11:24:56+08:00">2022-02-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-04-04 14:20:03" itemprop="dateModified" datetime="2023-04-04T14:20:03+08:00">2023-04-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="卷积神经网络（CNN）"><a href="#卷积神经网络（CNN）" class="headerlink" title="卷积神经网络（CNN）"></a>卷积神经网络（CNN）</h1><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C">卷积神经网络</a> （Convolutional Neural Network, CNN）是一种结构类似于人类或动物的 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A7%86%E8%A7%89%E7%B3%BB%E7%BB%9F">视觉系统</a> 的人工神经网络，包含一个或多个卷积层（Convolutional Layer）、池化层（Pooling Layer）和全连接层（Fully-connected Layer）。</p>
<h1 id="代码演示"><a href="#代码演示" class="headerlink" title="代码演示"></a>代码演示</h1><p>概念后面再说，先上代码。</p>
<h2 id="第一步，导包"><a href="#第一步，导包" class="headerlink" title="第一步，导包"></a>第一步，导包</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br></pre></td></tr></table></figure>

<h2 id="第二步，数据获取及预处理"><a href="#第二步，数据获取及预处理" class="headerlink" title="第二步，数据获取及预处理"></a>第二步，数据获取及预处理</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MNISTLoader</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        mnist = tf.keras.datasets.mnist</span><br><span class="line">        (self.train_data,self.train_label), \</span><br><span class="line">        (self.test_data, self.test_label) = mnist.load_data()</span><br><span class="line">        <span class="comment"># MNIST中的图像默认为uint8（0-255的数字）。以下代码将其归一化到0-1之间的浮点数，并在最后增加一维作为颜色通道</span></span><br><span class="line">        self.train_data = np.expand_dims(self.train_data.astype(np.float32) /</span><br><span class="line">                                         <span class="number">255.0</span>,</span><br><span class="line">                                         axis=-<span class="number">1</span>)  <span class="comment"># [60000, 28, 28, 1]</span></span><br><span class="line">        self.test_data = np.expand_dims(self.test_data.astype(np.float32) /</span><br><span class="line">                                        <span class="number">255.0</span>,</span><br><span class="line">                                        axis=-<span class="number">1</span>)  <span class="comment"># [10000, 28, 28, 1]</span></span><br><span class="line">        self.train_label = self.train_label.astype(np.int32)  <span class="comment"># [60000]</span></span><br><span class="line">        self.test_label = self.test_label.astype(np.int32)  <span class="comment"># [10000]</span></span><br><span class="line">        self.num_train_data, self.num_test_data = self.train_data.shape[</span><br><span class="line">            <span class="number">0</span>], self.test_data.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_batch</span>(<span class="params">self, batch_size</span>):</span><br><span class="line">        <span class="comment"># 从数据集中随机取出batch_size个元素并返回</span></span><br><span class="line">        index = np.random.randint(<span class="number">0</span>, self.num_train_data, batch_size)</span><br><span class="line">        <span class="keyword">return</span> self.train_data[index, :], self.train_label[index]</span><br></pre></td></tr></table></figure>

<h2 id="第三步，模型建立"><a href="#第三步，模型建立" class="headerlink" title="第三步，模型建立"></a>第三步，模型建立</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CNN</span>(tf.keras.Model):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.conv1 = tf.keras.layers.Conv2D(</span><br><span class="line">            filters=<span class="number">32</span>,  <span class="comment"># 卷积层神经元（卷积核）数目</span></span><br><span class="line">            kernel_size=[<span class="number">5</span>, <span class="number">5</span>],  <span class="comment"># 感受野大小</span></span><br><span class="line">            padding=<span class="string">&#x27;same&#x27;</span>,  <span class="comment"># padding策略（vaild 或 same：避免模型填充导致空间的下采样）</span></span><br><span class="line">            activation=tf.nn.relu  <span class="comment"># 激活函数</span></span><br><span class="line">        )</span><br><span class="line">        self.pool1 = tf.keras.layers.MaxPool2D(pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>)</span><br><span class="line">        self.conv2 = tf.keras.layers.Conv2D(filters=<span class="number">64</span>,</span><br><span class="line">                                            kernel_size=[<span class="number">5</span>, <span class="number">5</span>],</span><br><span class="line">                                            padding=<span class="string">&#x27;same&#x27;</span>,</span><br><span class="line">                                            activation=tf.nn.relu)</span><br><span class="line">        self.pool2 = tf.keras.layers.MaxPool2D(pool_size=[<span class="number">2</span>, <span class="number">2</span>], strides=<span class="number">2</span>)</span><br><span class="line">        self.flatten = tf.keras.layers.Reshape(target_shape=(<span class="number">7</span> * <span class="number">7</span> * <span class="number">64</span>, ))</span><br><span class="line">        self.dense1 = tf.keras.layers.Dense(units=<span class="number">1024</span>, activation=tf.nn.relu)</span><br><span class="line">        self.dense2 = tf.keras.layers.Dense(units=<span class="number">10</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    @tf.function 以转化为 SavedModel 支持的计算图，加快运行速度</span></span><br><span class="line"><span class="string">    model load完成后，使用modle.call()，由于自定义的模型类里可能有多个方法都需要导出，因此，需要告诉 TensorFlow Serving 每个方法在被客户端调用时分别叫做什么名字</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">    @tf.function(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">        input_signature=[tf.TensorSpec(<span class="params">[<span class="literal">None</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">1</span>], tf.float32</span>)]</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        x = self.conv1(inputs)  <span class="comment"># [batch_size, 28, 28, 32]</span></span><br><span class="line">        x = self.pool1(x)  <span class="comment"># [batch_size, 14, 14, 32]</span></span><br><span class="line">        x = self.conv2(x)  <span class="comment"># [batch_size, 14, 14, 64]</span></span><br><span class="line">        x = self.pool2(x)  <span class="comment"># [batch_size, 7, 7, 64]</span></span><br><span class="line">        x = self.flatten(x)  <span class="comment"># [batch_size, 7 * 7 * 64]</span></span><br><span class="line">        x = self.dense1(x)  <span class="comment"># [batch_size, 1024]</span></span><br><span class="line">        x = self.dense2(x)  <span class="comment"># [batch_size, 10]</span></span><br><span class="line">        output = tf.nn.softmax(x)</span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>

<h2 id="第四步，模型训练"><a href="#第四步，模型训练" class="headerlink" title="第四步，模型训练"></a>第四步，模型训练</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">num_epochs = <span class="number">5</span></span><br><span class="line">batch_size = <span class="number">50</span></span><br><span class="line">learning_rate = <span class="number">0.001</span></span><br><span class="line"></span><br><span class="line">model = CNN()</span><br><span class="line">data_loader = MNISTLoader()</span><br><span class="line"><span class="comment"># 优化器，这里使用常用的 Adam 优化器</span></span><br><span class="line">optimizer = tf.keras.optimizers.Adam(learning_rate=learning_rate)</span><br><span class="line"></span><br><span class="line"><span class="comment"># summaries and tensorboard</span></span><br><span class="line"><span class="comment"># log_dir = &quot;./tensorflow_board&quot;</span></span><br><span class="line"><span class="comment"># summary_writer = tf.summary.create_file_writer(log_dir)  # 实例化记录器</span></span><br><span class="line"><span class="comment"># tf.summary.trace_on(profiler=True)  # 开启Trace（可选）</span></span><br><span class="line"></span><br><span class="line">num_batches = <span class="built_in">int</span>(data_loader.num_train_data // batch_size * num_epochs)</span><br><span class="line"><span class="keyword">for</span> batch_index <span class="keyword">in</span> <span class="built_in">range</span>(num_batches):</span><br><span class="line">    X, y = data_loader.get_batch(batch_size)</span><br><span class="line">    <span class="built_in">print</span>(X.shape)</span><br><span class="line">    <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape:</span><br><span class="line">        y_pred = model(X)</span><br><span class="line">        <span class="comment">#交叉熵函数作为损失函数，其中 sparse 的含义是，真实的标签值 y_true 可以直接传入 int 类型的标签类别</span></span><br><span class="line">        loss = tf.keras.losses.sparse_categorical_crossentropy(y_true=y,</span><br><span class="line">                                                               y_pred=y_pred)</span><br><span class="line">        loss = tf.reduce_mean(loss)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;batch %d: loss %f&quot;</span> % (batch_index, loss.numpy()))</span><br><span class="line">        <span class="comment"># with summary_writer.as_default():  # 指定记录器</span></span><br><span class="line">        <span class="comment">#     tf.summary.scalar(&quot;loss&quot;, loss, step=batch_index)</span></span><br><span class="line"></span><br><span class="line">    grads = tape.gradient(loss, model.variables)</span><br><span class="line">    optimizer.apply_gradients(grads_and_vars=<span class="built_in">zip</span>(grads, model.variables))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="第五步，模型评估"><a href="#第五步，模型评估" class="headerlink" title="第五步，模型评估"></a>第五步，模型评估</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#评估器</span></span><br><span class="line">sparse_categorical_accuracy = tf.keras.metrics.SparseCategoricalAccuracy()</span><br><span class="line">num_batches = <span class="built_in">int</span>(data_loader.num_test_data // batch_size)</span><br><span class="line"></span><br><span class="line"><span class="comment"># for loop 评估预测结果与真实结果</span></span><br><span class="line"><span class="keyword">for</span> batch_index <span class="keyword">in</span> <span class="built_in">range</span>(num_batches):</span><br><span class="line">    start_index, end_index = batch_index * batch_size, (batch_index +</span><br><span class="line">                                                        <span class="number">1</span>) * batch_size</span><br><span class="line">    y_pred = model.predict(data_loader.test_data[start_index:end_index])</span><br><span class="line">    sparse_categorical_accuracy.update_state(</span><br><span class="line">        y_true=data_loader.test_label[start_index:end_index], y_pred=y_pred)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;test accuracy: %f&quot;</span> % sparse_categorical_accuracy.result())</span><br></pre></td></tr></table></figure>

<h2 id="第六步，-模型导出"><a href="#第六步，-模型导出" class="headerlink" title="第六步， 模型导出"></a>第六步， 模型导出</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tf.saved_model.save(<span class="keyword">model</span>,</span><br><span class="line">                    <span class="string">&quot;saved_with_signature/4&quot;</span>,</span><br><span class="line">                    signatures=&#123;<span class="string">&quot;call&quot;</span>: <span class="keyword">model</span>.call&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="第七步，TensorFlow-Serving-模型部署"><a href="#第七步，TensorFlow-Serving-模型部署" class="headerlink" title="第七步，TensorFlow Serving 模型部署"></a>第七步，TensorFlow Serving 模型部署</h2><p>首先得安装tensorflow-model-server，此处不做介绍。启动命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tensorflow_model_server</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--rest_api_port=6006</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--model_name=test_model</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--model_base_path=<span class="string">&quot;your_path/saved_with_signature/&quot;</span> <span class="comment">#绝对地址</span></span></span><br></pre></td></tr></table></figure>

<h2 id="第八步，调用测试"><a href="#第八步，调用测试" class="headerlink" title="第八步，调用测试"></a>第八步，调用测试</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">data_loader = MNISTLoader()</span><br><span class="line"></span><br><span class="line">data = json.dumps(&#123;</span><br><span class="line">    <span class="string">&quot;signature_name&quot;</span>: <span class="string">&quot;call&quot;</span>, <span class="comment"># self</span></span><br><span class="line">    <span class="string">&quot;instances&quot;</span>: data_loader.test_data[<span class="number">0</span>:<span class="number">100</span>].tolist()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">json_response = requests.post(</span><br><span class="line">    <span class="string">&#x27;http://localhost:6006/v1/models/test_model:predict&#x27;</span>,</span><br><span class="line">    data=data,</span><br><span class="line">    headers=headers)</span><br><span class="line"></span><br><span class="line">predictions = np.array(json.loads(json_response.text)[<span class="string">&#x27;predictions&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(np.argmax(predictions, axis=-<span class="number">1</span>)[<span class="number">0</span>:<span class="number">100</span>])</span><br><span class="line"><span class="built_in">print</span>(data_loader.test_label[<span class="number">0</span>:<span class="number">100</span>])</span><br></pre></td></tr></table></figure>

<h1 id="概念认知"><a href="#概念认知" class="headerlink" title="概念认知"></a>概念认知</h1><h2 id="张量"><a href="#张量" class="headerlink" title="张量"></a>张量</h2><blockquote>
<p>就像向量是标量的推广，矩阵是向量的推广一样，我们可以构建具有更多轴的数据结构。 张量（本小节中的“张量”指代数对象）为我们提供了描述具有任意数量轴的n维数组的通用方法。 例如，向量是一阶张量，矩阵是二阶张量。</p>
</blockquote>
<h2 id="池化层"><a href="#池化层" class="headerlink" title="池化层"></a>池化层</h2><blockquote>
<p>对图像进行降采样的过程，对于每一次滑动窗口中的所有值，输出其中的最大值（MaxPooling）、均值或其他方法产生的值。例如，对于一个三通道的 16×16 图像（即一个 <code>16*16*3</code> 的张量），经过感受野为 2×2，滑动步长为 2 的池化层，则得到一个 <code>8*8*3</code> 的张量。</p>
</blockquote>
<h2 id="卷积层"><a href="#卷积层" class="headerlink" title="卷积层"></a>卷积层</h2><blockquote>
<p>卷积层对输入和卷积核权重进行<a target="_blank" rel="noopener" href="https://zh.d2l.ai/chapter_convolutional-neural-networks/conv-layer.html#id2">互相关运算</a>，并在添加标量偏置之后产生输出。 所以，卷积层中的两个被训练的参数是卷积核权重和标量偏置。卷积层学到的是局部模式，而dense层学到的是全局模式。</p>
</blockquote>
<h2 id="卷积"><a href="#卷积" class="headerlink" title="卷积"></a>卷积</h2><blockquote>
<p>卷积的工作原理是这样的：在3维输入特征图上滑动（slide）这些3×3或5×5的窗口，在每个可能的位置停下来并提取周围特征的3维图块［形状为(window_height, window_width, input_depth)］。然后将每个这样的3维图块与学到的权重矩阵［叫作卷积核（convolution kernel），对所有图块都重复使用同一个卷积核］做张量积，使其转换成形状为(output_depth,)的1维向量。每个图块得到一个向量，然后对所有这些向量进行空间重组，将其转换成形状为(height, width, output_depth)的3维输出特征图。输出特征图中的每个空间位置都对应输入特征图中的相同位置（比如输出的右下角包含输入右下角的信息）。</p>
</blockquote>
<h1 id="使用预训练模型"><a href="#使用预训练模型" class="headerlink" title="使用预训练模型"></a>使用预训练模型</h1><p>实践证明，通过在小批量数据上的卷积神经网络可能精度方面还有待提高，在小型图像数据集上做深度学习，一种常用且非常有效的方法是使用预训练模型。使用预训练模型有两种方法：特征提取和微调模型。</p>
<h2 id="特征提取"><a href="#特征提取" class="headerlink" title="特征提取"></a>特征提取</h2><p>特征提取是指，利用之前训练好的模型学到的表示，从新样本中提取出有趣的特征，然后将这些特征输入一个新的分类器，从头开始训练这个分类器。</p>
<h2 id="微调预训练模型"><a href="#微调预训练模型" class="headerlink" title="微调预训练模型"></a>微调预训练模型</h2><p>微调是指，对于用于特征提取的已冻结模型基，将其顶部几层“<strong>解冻</strong>”，并对这解冻的几层与新增加的部分共同训练。之所以叫作微调，是因为它只略微调整了复用模型中更加抽象的表示，以便让这些表示与手头的问题更加相关。所以，它与特征提取互为补充。</p>
<p>微调的几层之前学到的表示将被破坏。因此，微调的步骤如下。</p>
<ol>
<li>在已经训练好的基网络（base network）上添加自定义网络。</li>
<li>冻结基网络。</li>
<li>训练新添加的部分。（注意，做特征提取的时候，已经完成了这三个步骤。）</li>
<li>解冻基网络的一些层。（注意，你不应该解冻“批量规范化”层。VGG16中没有这样的层，所以这里无须过多关注。）</li>
<li>共同训练解冻的这些层和新添加的部分。</li>
</ol>
<p>卷积神经网络是用于计算机视觉任务的最佳机器学习模型。即使在非常小的数据集上从头开始训练一个卷积神经网络，也可以得到不错的结果。卷积神经网络通过学习模块化模式和概念的层次结构来表示视觉世界。模型在小型数据集上的主要问题是过拟合。在处理图像数据时，数据增强是降低过拟合的强大方法。利用特征提取，可以很容易地将现有的卷积神经网络复用于新的数据集。对于小型图像数据集，这是一种很有用的方法。作为特征提取的补充，你还可以使用微调技术，将现有模型之前学到的一些数据表示应用于新问题。这种方法可以进一步提高模型性能。</p>
<h1 id="学习地址"><a href="#学习地址" class="headerlink" title="学习地址"></a><strong>学习地址</strong></h1><p><a target="_blank" rel="noopener" href="https://tf.wiki/zh_hans/appendix/tfds.html"><a target="_blank" rel="noopener" href="https://tf.wiki/zh_hans"> 简单粗暴 TensorFlow 2</a></a></p>
<p><a target="_blank" rel="noopener" href="https://zh.d2l.ai/chapter_preliminaries/index.html">动手学深度学习</a></p>
<p>Python深度学习（第2版）作者：[美]弗朗索瓦·肖莱（François Chollet）译者：张亮出版社：人民邮电出版社</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shizhenqiang.github.io/2022/01/17/Airflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chelf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chelf Blog">
      <meta itemprop="description" content="We used to look up at the sky and wonder at our place in the stars, now we just look down and worry about our place in the dirt.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Chelf Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/17/Airflow/" class="post-title-link" itemprop="url">Airflow</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-17 17:10:46" itemprop="dateCreated datePublished" datetime="2022-01-17T17:10:46+08:00">2022-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-04 11:49:49" itemprop="dateModified" datetime="2022-11-04T11:49:49+08:00">2022-11-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、-什么是airflow"><a href="#一、-什么是airflow" class="headerlink" title="一、 什么是airflow?"></a>一、 什么是airflow?</h2><p>它是一个具有（DAG）工作流调度器，并可视化其作业流程的一个平台。<a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/"><strong>Documentation&gt;&gt;</strong></a></p>
<blockquote>
<p><em>Airflow is a platform to programmatically author, schedule and monitor workflows.</em></p>
</blockquote>
<h2 id="二、什么是celery？"><a href="#二、什么是celery？" class="headerlink" title="二、什么是celery？"></a>二、什么是celery？</h2><p>它是一个简单、灵活且可靠的,处理大量消息的<strong>分布式</strong>系统,专注于实时处理的<strong>异步任务队列</strong>,同时也支持<strong>任务调度</strong>。 <a target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/"><strong>Documentation&gt;&gt;</strong></a></p>
<blockquote>
<p><em>Celery is a simple, flexible and reliable distributed system to process vast amounts of messages, while providing operations with the tools required to maintain such a system.</em></p>
</blockquote>
<h2 id="三、什么是Executor"><a href="#三、什么是Executor" class="headerlink" title="三、什么是Executor?"></a>三、什么是Executor?</h2><p>那些可以运行任务的执行者。例如：</p>
<p><strong>Local Executors</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/debug.html">Debug Executor</a></li>
<li><a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/local.html">Local Executor</a></li>
<li><a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/sequential.html">Sequential Executor</a></li>
</ul>
<p><strong>Remote Executors</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/celery.html">Celery Executor</a></li>
<li><a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/celery_kubernetes.html">CeleryKubernetes Executor</a></li>
<li><a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/dask.html">Dask Executor</a></li>
<li><a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/kubernetes.html">Kubernetes Executor</a></li>
<li><a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/local_kubernetes.html">LocalKubernetes Executor</a></li>
</ul>
<p>这里主要说明一下celery作为excutor的一个架构及流程。</p>
<img src="/2022/01/17/Airflow/graphviz-91fd3ca4f3dc01a69b3f84fbcd6b5c7975945ba4.png" class title="Architecture asset_img">

<ul>
<li><p><strong>Workers</strong> - Execute the assigned tasks</p>
</li>
<li><p><strong>Scheduler</strong> - Responsible for adding the necessary tasks to the queue</p>
</li>
<li><p><strong>Web server</strong> - HTTP Server provides access to DAG&#x2F;task status information</p>
</li>
<li><p><strong>Database</strong> - Contains information about the status of tasks, DAGs, Variables, connections, etc.</p>
</li>
<li><p><strong>Celery</strong> - Queue mechanism</p>
</li>
<li><p><strong>Broker</strong> - Stores commands for execution</p>
</li>
<li><p><strong>Result backend</strong> - Stores status of completed commands</p>
</li>
</ul>
<p>其中各个组件的联系如下：</p>
<ul>
<li>[1] <strong>Web server</strong> –&gt; <strong>Workers</strong> - Fetches task execution logs</li>
<li>[2] <strong>Web server</strong> –&gt; <strong>DAG files</strong> - Reveal the DAG structure</li>
<li>[3] <strong>Web server</strong> –&gt; <strong>Database</strong> - Fetch the status of the tasks</li>
<li>[4] <strong>Workers</strong> –&gt; <strong>DAG files</strong> - Reveal the DAG structure and execute the tasks</li>
<li>[5] <strong>Workers</strong> –&gt; <strong>Database</strong> - Gets and stores information about connection configuration, variables and XCOM.</li>
<li>[6] <strong>Workers</strong> –&gt; <strong>Celery’s result backend</strong> - Saves the status of tasks</li>
<li>[7] <strong>Workers</strong> –&gt; <strong>Celery’s broker</strong> - Stores commands for execution</li>
<li>[8] <strong>Scheduler</strong> –&gt; <strong>DAG files</strong> - Reveal the DAG structure and execute the tasks</li>
<li>[9] <strong>Scheduler</strong> –&gt; <strong>Database</strong> - Store a DAG run and related tasks</li>
<li>[10] <strong>Scheduler</strong> –&gt; <strong>Celery’s result backend</strong> - Gets information about the status of completed tasks</li>
<li>[11] <strong>Scheduler</strong> –&gt; <strong>Celery’s broker</strong> - Put the commands to be executed</li>
</ul>
<p>总结，webserver可视化DAG，获取任务状态，捕捉日志。Worker是执行任务的，同时存储相应的状态。scheduler是调度任务的，并将DAG存储下来。</p>
<p>如上，使用<a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/celery.html">Celery Executor</a>，得运行scheduler，worker。其中-D使用守护进程运行。当然你可以启动flower来监控<a target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/executor/celery.html">Celery Executor</a>的执行状况。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">airflow scheduler -D</span><br><span class="line">airflow celery worker -D</span><br><span class="line">airflow webserver -D</span><br><span class="line"></span><br><span class="line"># airflow celery flower #</span><br></pre></td></tr></table></figure>

<h2 id="四、什么是backfill？"><a href="#四、什么是backfill？" class="headerlink" title="四、什么是backfill？"></a>四、什么是backfill？</h2><p>可以在一定的时间范围内，运行一些DAG。</p>
<blockquote>
<p>Run subsections of a DAG for a specified date range.</p>
</blockquote>
<p>例如：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">airflow</span> dags backfill -s <span class="number">2022</span>-<span class="number">06</span>-<span class="number">11</span> -e <span class="number">2022</span>-<span class="number">06</span>-<span class="number">12</span> --reset-dagruns tutorial</span><br></pre></td></tr></table></figure>

<p>其中，reset_dag_run如果设置，那么他会提示是是否清除之前的DAG运行实例，重新运行。而rerun_failed_tasks则会自动执行在这个时间范围内的错误任务。</p>
<h2 id="五、有何依赖？"><a href="#五、有何依赖？" class="headerlink" title="五、有何依赖？"></a>五、有何依赖？</h2><p>airflow安装：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">AIRFLOW_VERSION</span>=<span class="number">2.3</span><span class="number">.2</span></span><br><span class="line"><span class="variable constant_">PYTHON_VERSION</span>=<span class="string">&quot;$(python --version | cut -d &quot;</span> <span class="string">&quot; -f 2 | cut -d &quot;</span>.<span class="string">&quot; -f 1-2)&quot;</span></span><br><span class="line"><span class="variable constant_">CONSTRAINT_URL</span>=<span class="string">&quot;https://raw.githubusercontent.com/apache/airflow/constraints-$&#123;AIRFLOW_VERSION&#125;/constraints-$&#123;PYTHON_VERSION&#125;.txt&quot;</span></span><br><span class="line">pip install <span class="string">&quot;apache-airflow[async,postgres,google]==$&#123;AIRFLOW_VERSION&#125;&quot;</span> --constraint <span class="string">&quot;$&#123;CONSTRAINT_URL&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>你可以从文档中查看安装步骤，比如利用pypip安装，升级。<strong>注意版本</strong>。</p>
<p>mysql安装</p>
<p>如果用mysql作为元数据库，那么请注意版本以及配置编码、时间戳默认值等事宜。比如其中：</p>
<blockquote>
<p><em>In addition, you also should pay particular attention to MySQL’s encoding. Although the utf8mb4 character set is more and more popular for MySQL (actually, utf8mb4 becomes default character set in MySQL8.0), using the utf8mb4 encoding requires additional setting in Airflow 2+ (See more details in #7570.). If you use utf8mb4 as character set, you should also set sql_engine_collation_for_ids&#x3D;utf8mb3_bin.</em></p>
<p>We rely on more strict ANSI SQL settings for MySQL in order to have sane defaults. Make sure to have specified <code>explicit_defaults_for_timestamp=1</code> option under <code>[mysqld]</code> section in your <code>my.cnf</code> file. You can also activate these options with the <code>--explicit-defaults-for-timestamp</code> switch passed to <code>mysqld</code> executable <em><strong><a target="_blank" rel="noopener" href="http://airflow.incubator.apache.org/docs/apache-airflow/2.3.2/howto/set-up-database.html?highlight=utf8mb3_bin#setting-up-a-mysql-database">&gt;&gt;DOC</a></strong></em></p>
</blockquote>
<p>celery安装</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> <span class="string">&quot;apache-airflow[celery]==2.3.2&quot;</span> --constraint <span class="string">&quot;https://raw.githubusercontent.com/apache/airflow/constraints-2.3.2/constraints-3.7.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p>redis作为celery的backend时，还要安装redis，<strong>注意版本</strong>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://shizhenqiang.github.io/2021/07/18/Flink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chelf">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chelf Blog">
      <meta itemprop="description" content="We used to look up at the sky and wonder at our place in the stars, now we just look down and worry about our place in the dirt.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Chelf Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/07/18/Flink/" class="post-title-link" itemprop="url">Flink 解读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-18 15:36:12" itemprop="dateCreated datePublished" datetime="2021-07-18T15:36:12+08:00">2021-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-05 15:29:45" itemprop="dateModified" datetime="2022-12-05T15:29:45+08:00">2022-12-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97/" itemprop="url" rel="index"><span itemprop="name">实时计算</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、什么是Flink？"><a href="#一、什么是Flink？" class="headerlink" title="一、什么是Flink？"></a>一、什么是Flink？</h2><p>Apache Flink 是一个框架和分布式处理引擎，用于在无边界和有边界数据流上进行有状态的计算。Flink 能在所有常见集群环境中运行，并能以内存速度和任意规模进行计算。</p>
<blockquote>
<p><strong>Apache Flink</strong> is a framework and distributed processing engine for stateful computations over <em>unbounded</em> and <em>bounded</em> data streams. Flink has been designed to run in <em>all common cluster environments</em> perform computations at <em>in-memory</em> speed and at <em>any scale</em>.</p>
</blockquote>
<h2 id="二、-时间的概念"><a href="#二、-时间的概念" class="headerlink" title="二、 时间的概念"></a>二、 时间的概念</h2><p> <strong>Processing time:</strong> 执行各自操作的系统时间</p>
<p><strong>Event time:</strong> 各自事件的时间，发生在推送机器上的时间，在进入flink前的汇总信息的时间。使用时，必须指定如何生成<em>Event Time Watermarks</em>。窗口大小等分，水印是防止乱序而生，牺牲了一定的实时性，提高了准确性。</p>
<p>触发机制：</p>
<p>1、watermark 时间  &#x3D; 当前到来数据的时间戳 - 乱序容忍时间；<br>2、 watermark 时间 &gt;&#x3D; window_end_time；<br>3、在 [window_start_time,window_end_time) 中有数据存在，这个窗口是左闭右开的。</p>
<p>window_start_time:</p>
<img src="/2021/07/18/Flink/image-20221205095123973.png" class title="window start time % } {% asset_img event_processing_time.svg event processing time asset_img">

<p>输出水印：</p>
<img src="/2021/07/18/Flink/image-20221017114850730.png" class title="processes asset_img">

<p>输出窗口的起止：</p>
<img src="/2021/07/18/Flink/image-20221017114927866.png" class title="processes asset_img">

<p>注意前闭后开，源代码中毫秒使用-1。<br>这样就可以知道，例如窗口大小为windowsize为2分钟，水印设置1分钟，其实是延迟一分钟进行数据触发  watermark 时间 &gt;&#x3D; window_end_time。</p>
<h2 id="三、窗口的类型"><a href="#三、窗口的类型" class="headerlink" title="三、窗口的类型"></a>三、窗口的类型</h2><ol>
<li><strong>Keyed Windows</strong></li>
<li><strong>Non-Keyed Windows</strong></li>
</ol>
<ul>
<li><p>滑动窗口</p>
</li>
<li><p>滚动窗口</p>
</li>
<li><p>全局窗口</p>
</li>
<li><p>会话窗口</p>
<p> 会话窗口是当前窗口等待一段时间(指定)没有数据进入后,窗口结束进行计算.</p>
</li>
</ul>
<h2 id="四、定时器"><a href="#四、定时器" class="headerlink" title="四、定时器"></a>四、定时器</h2><p><a target="_blank" rel="noopener" href="https://github.com/apache/flink-training/blob/master/long-ride-alerts/README_zh.md">练习: <code>ProcessFunction</code> 及定时器（长车程警报）</a></p>
<p>尤其带状态的定时器一定要注意：</p>
<ol>
<li>状态什么时候clear？</li>
<li>定时器什么时候delete？</li>
</ol>
<h3 id="底线"><a href="#底线" class="headerlink" title="底线"></a>底线</h3><p>不管如何聪明地处理保持什么样的状态，以及选择保持多长时间，我们最终都应该清除它——否则状态将以无限的方式增长。 如果丢失了这些信息，我们将冒着延迟事件导致错误或重复结果的风险。</p>
<p>在永久地保持状态与在事件延迟时偶尔出错之间的权衡是有状态流处理中固有的挑战。</p>
<h3 id="如果你想走得更远"><a href="#如果你想走得更远" class="headerlink" title="如果你想走得更远"></a>如果你想走得更远</h3><p>对于下列的每一项，添加测试以检查所需的行为。</p>
<ul>
<li>扩展解决方案，使其永远不会泄漏状态。</li>
<li>定义事件丢失的含义，检测丢失的 START 和 END 事件，并将一些通知发送到旁路输出。</li>
</ul>
<h2 id="五、广播"><a href="#五、广播" class="headerlink" title="五、广播"></a>五、广播</h2><ul>
<li><p>if that is <strong>keyed</strong>, then the function is a <code>KeyedBroadcastProcessFunction</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">KeyedBroadcastProcessFunction</span>&lt;KS, IN1, IN2, OUT&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(IN1 value, ReadOnlyContext ctx, Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">processBroadcastElement</span><span class="params">(IN2 value, Context ctx, Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(<span class="type">long</span> timestamp, OnTimerContext ctx, Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>if it is <strong>non-keyed</strong>, the function is a <code>BroadcastProcessFunction</code>.</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BroadcastProcessFunction</span>&lt;IN1, IN2, OUT&gt; <span class="keyword">extends</span> <span class="title class_">BaseBroadcastProcessFunction</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(IN1 value, ReadOnlyContext ctx, Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">processBroadcastElement</span><span class="params">(IN2 value, Context ctx, Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    如上，都包含两个方法，分别是processElement()和 processBroadcastElement()，而这两个方法本身也有不同，非广播流方法（processElement）是一个 ReadOnlyContext而广播流（processBroadcastElement）方法是<strong>read-write access</strong>的，因为flink本身不具备cross-task通信，为了保证所有任务修改广播任务内容状态都会以同样的方式传到接下来每一个的输入元素，仅把broadcast设为可读可写。</p>
<p>比如风控项目中，风控规则主要问题是规则和阈值，当有新的阈值时可以通过 BroadcastStream 广播到各个算子，可以很好的去实时处理来自业务端的阈值设定。</p>
<p>​    除了以上说明还有几点重要的考虑：</p>
<ul>
<li><strong>There is no cross-task communication</strong> </li>
<li><strong>Order of events in Broadcast State may differ across tasks</strong> </li>
<li><strong>All tasks checkpoint their broadcast state</strong> </li>
<li><strong>No RocksDB state backend</strong></li>
</ul>
<h2 id="六、架构"><a href="#六、架构" class="headerlink" title="六、架构"></a>六、架构</h2><p>主要包含两种类型：</p>
<p>a <em>JobManager</em> and one or more <em>TaskManagers</em>.</p>
<img src="/2021/07/18/Flink/processes.svg" class title="processes asset_img">

<ol>
<li><h3 id="JobManager"><a href="#JobManager" class="headerlink" title="JobManager"></a>JobManager</h3><p>作业管理器：负责协调资源分配和作业执行。资源分配完成后，给到TaskManagers.</p>
<p>但是如果只有一个jobManager的话，很容易不高可用。所以，standalone与Yarn集群配置可实现高可用模式。</p>
</li>
<li><h3 id="TaskManagers"><a href="#TaskManagers" class="headerlink" title="TaskManagers"></a>TaskManagers</h3></li>
</ol>
<p>​       任务管理器：从jobManager那里接受任务后，使用slot（资源的最小抽象）资源，启动线程执行任务，不断的给jobManager报告状态。</p>
<h2 id="七、Task-Slots-？"><a href="#七、Task-Slots-？" class="headerlink" title="七、Task Slots ？"></a>七、Task Slots ？</h2><p>​       每个slot都可以分配到独立的内存，可以内存管理。但是CPU是共享的。与并行度直接关联 ，实际情况下，并行度可能小于slot的数量。slot可以共享，提供资源利用率。</p>
<h2 id="八、反压"><a href="#八、反压" class="headerlink" title="八、反压"></a>八、反压</h2><p>​       简单一说，反压的过程就是解决上游数据生产速率大于下游数据消费，通过动态调整发送速率和消费速率，更好的进行网络流控。Flink1.5之前是采用基于TCP的反压机制，但是基于TCP的反压机制有以下问题：</p>
<p>1、一个 TaskManager 内通常会有多个Task，它们底层会复用同一个Socket，一旦某个Task反压导致Socket阻塞不可用，即便其它 Task 关联的缓冲池仍然存在空余，但也都无法向 TCP 连接中写入数据或者从中读取数据。<br>2、基于底层TCP流控的反压机制，从 ResultPartition 到 Netty 到 Socket整条链路较长，会导致反压行为不够灵敏，动态反馈过程比较迟钝。</p>
<p>于是，基于Credit算法的反压机制对上述问题做了优化，解决了两个问题：</p>
<p>1、可以直接在 ResultPartition 层实现反压，而不用将压力流经过多层传递，层层反馈。提高了反压效率，降低了延迟；<br>2、不会把底层socket打满，从而阻碍网络数据传输，不会让单个 Task 的瓶颈成为整个TaskManager 的瓶颈；</p>
<p>具体的反压流程可参考：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2ODAyNTgyMQ==&mid=2247485234&idx=1&sn=4f25023fc4dd224cc8b4ee25c57ea8ea&chksm=ceb3d380f9c45a964c646a4d2189b08ba24d7a5549e355dd753b4cd34e184957b5936b5f1630&mpshare=1&scene=1&srcid=1031kqX74jmXHqZRFzPWY8dM&sharer_sharetime=1667201424602&sharer_shareid=f59adca26e8157d4646f4becf01a5c87&version=3.1.20.6008&platform=win#rd">Flink反压原理深入浅出及解决思路</a></p>
<h2 id="九、远程提交YARN"><a href="#九、远程提交YARN" class="headerlink" title="九、远程提交YARN"></a>九、远程提交YARN</h2><p>   注意：指定flink_conf.yaml加载yarn其路径下面的配置文件如yarn_site.yaml</p>
<h2 id="十、CLI"><a href="#十、CLI" class="headerlink" title="十、CLI"></a>十、CLI</h2><p>SavePoint:</p>
<p>手动保存，用于重启，更改jar包，并行度等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flink savepoint -m yarn-cluster &lt;jobId&gt; [savepointDirectory] -yid [yarnAppId]</span><br></pre></td></tr></table></figure>

<p>注意顺序；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Triggering savepoint <span class="keyword">for</span> job 7aa51e5560905ce0c45e019a0f2772a4.</span><br><span class="line">Waiting <span class="keyword">for</span> response...</span><br><span class="line">Savepoint completed. Path: [savepointDirectory]/savepoint-7aa51e-eb49828b92de</span><br><span class="line">You can resume your program from this savepoint with the run <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>

<p>启动是从savepoint启动。注意此时savepointPath用上述命令后的Path: [savepointDirectory]&#x2F;savepoint-7aa51e-eb49828b92de.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/flink run -s &lt;savepointPath&gt;</span><br></pre></td></tr></table></figure>

<p>当然你也可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/flink stop [-p targetDirectory] [-d] &lt;jobID&gt; <span class="comment">#推荐</span></span><br><span class="line"></span><br><span class="line">./bin/flink cancel -s [savepointDirectory] &lt;jobID&gt; <span class="comment">#use stop instead</span></span><br></pre></td></tr></table></figure>

<p>checkpoint：</p>
<p>启动时可以再flink-conf.yml 里面加一个 execution.checkpointing.interval: 10000，也可以在代码中配置。</p>
<p>当然还要设置相关的state.backend等配置。此时可以实现重启策略（代码或者配置中都可以配置）。</p>
<p><strong>实践出真知</strong></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ggHmSc86mN3I7r6snjqxWQ">https://mp.weixin.qq.com/s/ggHmSc86mN3I7r6snjqxWQ</a></li>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.12/concepts/flink-architecture.html">https://nightlies.apache.org/flink/flink-docs-release-1.12/concepts/flink-architecture.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/flink-training/">https://github.com/apache/flink-training/</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chelf</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
